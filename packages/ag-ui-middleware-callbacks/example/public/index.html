<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AG-UI Middleware Example</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    /* Config Modal */
    .config-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .config-modal.hidden {
      display: none;
    }

    .config-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      width: 400px;
      max-width: 90%;
    }

    .config-content h2 {
      font-size: 18px;
      margin-bottom: 16px;
    }

    .config-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    .form-group input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #007aff;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #007aff;
      color: white;
      margin-top: 8px;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    /* Chat Area */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 700px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }

    .message.assistant .message-bubble {
      background: white;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .message.user .message-bubble {
      background: #007aff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    /* Tool Call Indicator */
    .tool-indicator {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: #856404;
      margin: 8px 0;
      display: none;
    }

    .tool-indicator.visible {
      display: block;
    }

    /* Tool Result (Expanded View) */
    .tool-result {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0 8px 60px;
      font-size: 12px;
      display: none;
    }

    .tool-result.visible {
      display: block;
    }

    .tool-result-header {
      font-weight: 600;
      color: #495057;
      margin-bottom: 4px;
    }

    .tool-result-content {
      font-family: 'SF Mono', Monaco, monospace;
      color: #28a745;
    }

    /* Input Area */
    .input-area {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: white;
      border-top: 1px solid #e0e0e0;
      border-radius: 12px;
      margin-top: auto;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .input-area input:focus {
      outline: none;
      border-color: #007aff;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.visible {
      transform: translateY(0);
      opacity: 1;
    }

    /* Debug Panel */
    .debug-toggle {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: #6c757d;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      opacity: 0.5;
    }

    .debug-toggle:hover {
      opacity: 1;
    }

    .debug-panel {
      position: fixed;
      bottom: 40px;
      left: 10px;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 8px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }

    .debug-panel.visible {
      display: block;
    }

    .debug-event {
      margin-bottom: 4px;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .debug-event:hover {
      background: #333;
    }

    .debug-event .type {
      color: #9cdcfe;
    }

    .debug-event .data {
      color: #ce9178;
    }
  </style>
</head>
<body>
  <!-- Config Modal (shown on first visit) -->
  <div class="config-modal" id="configModal">
    <div class="config-content">
      <h2>Configure Agent</h2>
      <div class="config-form">
        <div class="form-group">
          <label>Base URL</label>
          <input type="text" id="baseUrl" placeholder="https://api.openai.com/v1" value="https://api.openai.com/v1">
        </div>
        <div class="form-group">
          <label>API Key</label>
          <input type="password" id="apiKey" placeholder="sk-...">
        </div>
        <div class="form-group">
          <label>Model</label>
          <input type="text" id="model" placeholder="gpt-4o-mini" value="gpt-4o-mini">
        </div>
        <button class="btn btn-primary" id="saveConfig">Start Chat</button>
      </div>
    </div>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <div class="messages" id="messages">
      <!-- Empty canvas - agent is ready but no messages yet -->
    </div>

    <!-- Tool Execution Indicator -->
    <div class="tool-indicator" id="toolIndicator">
      <span id="toolName"></span>
    </div>

    <!-- Tool Result Container -->
    <div id="toolResults"></div>

    <!-- Input Area -->
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button class="btn btn-primary" id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Debug Panel -->
  <button class="debug-toggle" id="debugToggle">DEBUG</button>
  <div class="debug-panel" id="debugPanel"></div>

  <script>
    // ============================================================================
    // State Management
    // ============================================================================

    let sessionId = null;
    let eventSource = null;
    let currentMessageId = null;
    let currentToolCallId = null;
    let messageBuffer = "";
    let config = null;

    // DOM Elements
    const elements = {
      configModal: document.getElementById('configModal'),
      baseUrl: document.getElementById('baseUrl'),
      apiKey: document.getElementById('apiKey'),
      model: document.getElementById('model'),
      saveConfig: document.getElementById('saveConfig'),
      messages: document.getElementById('messages'),
      messageInput: document.getElementById('messageInput'),
      sendBtn: document.getElementById('sendBtn'),
      toolIndicator: document.getElementById('toolIndicator'),
      toolName: document.getElementById('toolName'),
      toolResults: document.getElementById('toolResults'),
      toast: document.getElementById('toast'),
      debugToggle: document.getElementById('debugToggle'),
      debugPanel: document.getElementById('debugPanel'),
    };

    // ============================================================================
    // Utility Functions
    // ============================================================================

    function showToast(message) {
      elements.toast.textContent = message;
      elements.toast.classList.add('visible');
      setTimeout(() => {
        elements.toast.classList.remove('visible');
      }, 5000);
    }

    function addDebugEvent(type, data) {
      const eventEl = document.createElement('div');
      eventEl.className = 'debug-event';
      eventEl.innerHTML = `<span class="type">${type}</span>: <span class="data">${JSON.stringify(data).substring(0, 100)}...</span>`;
      elements.debugPanel.appendChild(eventEl);
      elements.debugPanel.scrollTop = elements.debugPanel.scrollHeight;
    }

    function toggleDebug() {
      elements.debugPanel.classList.toggle('visible');
    }

    // ============================================================================
    // Message Handling
    // ============================================================================

    function addUserMessage(text) {
      const messageEl = document.createElement('div');
      messageEl.className = 'message user';
      messageEl.innerHTML = `<div class="message-bubble">${escapeHtml(text)}</div>`;
      elements.messages.appendChild(messageEl);
      scrollToBottom();
    }

    function startAssistantMessage() {
      const messageEl = document.createElement('div');
      messageEl.className = 'message assistant';
      messageEl.id = 'currentMessage';
      messageEl.innerHTML = `<div class="message-bubble"></div>`;
      elements.messages.appendChild(messageEl);
      currentMessageId = 'currentMessage';
      messageBuffer = "";
      scrollToBottom();
      return messageEl;
    }

    function appendToCurrentMessage(delta) {
      const messageEl = document.getElementById(currentMessageId);
      if (messageEl) {
        messageBuffer += delta;
        messageEl.querySelector('.message-bubble').textContent = messageBuffer;
        scrollToBottom();
      }
    }

    function scrollToBottom() {
      elements.messages.scrollTop = elements.messages.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================================================
    // Tool Handling
    // ============================================================================

    function showToolCall(toolName) {
      elements.toolName.textContent = `Using tool: ${toolName}`;
      elements.toolIndicator.classList.add('visible');
    }

    function hideToolCall() {
      elements.toolIndicator.classList.remove('visible');
    }

    function showToolResult(toolCallId, toolName, result) {
      const resultEl = document.createElement('div');
      resultEl.className = 'tool-result visible';
      resultEl.id = `tool-result-${toolCallId}`;
      resultEl.innerHTML = `
        <div class="tool-result-header">Tool: ${toolName}</div>
        <div class="tool-result-content">${escapeHtml(result)}</div>
      `;
      elements.toolResults.appendChild(resultEl);
      scrollToBottom();
    }

    function clearToolResults() {
      elements.toolResults.innerHTML = '';
    }

    // ============================================================================
    // AG-UI Event Handlers
    // ============================================================================

    function handleRunStarted(event) {
      addDebugEvent('RUN_STARTED', event);
      clearToolResults();
      messageBuffer = "";
    }

    function handleTextMessageStart(event) {
      addDebugEvent('TEXT_MESSAGE_START', event);
      currentMessageId = event.messageId;
      startAssistantMessage();
    }

    function handleTextMessageContent(event) {
      addDebugEvent('TEXT_MESSAGE_CONTENT', event);
      if (event.delta) {
        appendToCurrentMessage(event.delta);
      }
    }

    function handleTextMessageEnd(event) {
      addDebugEvent('TEXT_MESSAGE_END', event);
      
      // If no TEXT_MESSAGE_CONTENT was received, extract content from STATE_SNAPSHOT
      if (messageBuffer === "" && currentMessageId) {
        const snapshots = document.querySelectorAll('.debug-event');
        for (let i = snapshots.length - 1; i >= 0; i--) {
          const text = snapshots[i].textContent;
          if (text.includes('STATE_SNAPSHOT') && text.includes('model_request')) {
            try {
              const data = JSON.parse(text.split('data: ')[1].split('...')[0]);
              if (data.snapshot?.model_request?.messages?.[0]?.kwargs?.content) {
                appendToCurrentMessage(data.snapshot.model_request.messages[0].kwargs.content);
                break;
              }
            } catch (e) {
              // Try next event
            }
          }
        }
      }
      
      currentMessageId = null;
    }

    function handleToolCallStart(event) {
      addDebugEvent('TOOL_CALL_START', event);
      currentToolCallId = event.toolCallId;
      showToolCall(event.toolCallName);
    }

    function handleToolCallArgs(event) {
      addDebugEvent('TOOL_CALL_ARGS', event);
    }

    function handleToolCallEnd(event) {
      addDebugEvent('TOOL_CALL_END', event);
      hideToolCall();
    }

    function handleToolCallResult(event) {
      addDebugEvent('TOOL_CALL_RESULT', event);
      if (event.content) {
        showToolResult(event.toolCallId, event.toolCallName || 'Unknown', event.content);
      }
    }

    function handleRunFinished(event) {
      addDebugEvent('RUN_FINISHED', event);
      currentToolCallId = null;
      hideToolCall();
    }

    function handleRunError(event) {
      addDebugEvent('RUN_ERROR', event);
      showToast(`Error: ${event.message || 'Unknown error'}`);
      hideToolCall();
    }

    function handleStateSnapshot(event) {
      addDebugEvent('STATE_SNAPSHOT', event);
    }

    // AG-UI Event Handler Map
    const eventHandlers = {
      'RUN_STARTED': handleRunStarted,
      'TEXT_MESSAGE_START': handleTextMessageStart,
      'TEXT_MESSAGE_CONTENT': handleTextMessageContent,
      'TEXT_MESSAGE_END': handleTextMessageEnd,
      'TOOL_CALL_START': handleToolCallStart,
      'TOOL_CALL_ARGS': handleToolCallArgs,
      'TOOL_CALL_END': handleToolCallEnd,
      'TOOL_CALL_RESULT': handleToolCallResult,
      'RUN_FINISHED': handleRunFinished,
      'RUN_ERROR': handleRunError,
      'STATE_SNAPSHOT': handleStateSnapshot,
    };

    // ============================================================================
    // Configuration
    // ============================================================================

    function saveConfig() {
      const baseUrl = elements.baseUrl.value.trim();
      const apiKey = elements.apiKey.value.trim();
      const model = elements.model.value.trim();

      if (!baseUrl || !model) {
        showToast('Please enter Base URL and Model');
        return;
      }

      config = { baseUrl, apiKey, model };
      elements.configModal.classList.add('hidden');
      
      // Focus on message input
      elements.messageInput.focus();
    }

    // ============================================================================
    // Message Sending (Fire-and-Forget Pattern)
    // ============================================================================

    async function sendMessage() {
      const text = elements.messageInput.value.trim();
      if (!text) return;

      if (!config) {
        showToast('Please configure the agent first');
        return;
      }

      // Add user message to UI
      addUserMessage(text);
      elements.messageInput.value = '';
      elements.messageInput.focus();

      try {
        // POST: Send message to create or update session
        const postBody = {
          messages: [{ role: 'user', content: text }],
          config: config,
        };
        
        if (sessionId) {
          postBody.sessionId = sessionId;
        }

        const postResponse = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postBody),
        });

        if (!postResponse.ok) {
          throw new Error('Failed to send message');
        }

        const data = await postResponse.json();
        sessionId = data.sessionId;

        // GET: Connect to SSE to receive agent response
        connectEventSource();

      } catch (error) {
        console.error('Send error:', error);
        showToast(`Failed to send: ${error.message}`);
      }
    }

    function connectEventSource() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(`/chat?sessionId=${sessionId}`);

      eventSource.onopen = () => {
        addDebugEvent('SSE', 'Connection opened');
      };

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          const handler = eventHandlers[data.type];
          if (handler) {
            handler(data);
          } else {
            addDebugEvent('UNKNOWN', data.type);
          }
        } catch (error) {
          console.error('Error parsing event:', error);
        }
      };

      eventSource.onerror = (error) => {
        addDebugEvent('SSE', 'Stream completed');
        eventSource.close();
        eventSource = null;
      };
    }

    // ============================================================================
    // Event Listeners
    // ============================================================================

    elements.saveConfig.addEventListener('click', saveConfig);
    elements.sendBtn.addEventListener('click', sendMessage);
    elements.messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    elements.debugToggle.addEventListener('click', toggleDebug);

    // Check if config exists in memory (for page refresh)
    if (config) {
      elements.configModal.classList.add('hidden');
    }
  </script>
</body>
</html>
